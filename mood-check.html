<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Check ‚Äî EduFace</title>
    <link rel="stylesheet" href="css/global.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .mood-page {
            padding: 6rem 0 3rem;
        }

        .mood-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .mood-cam-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
        }

        .mood-cam-card h3 {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .mood-cam-card .sub {
            color: var(--text-muted);
            font-size: 0.82rem;
            margin-bottom: 1.5rem;
        }

        .mood-webcam {
            width: 100%;
            aspect-ratio: 4/3;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid var(--border-color);
            background: #000;
            margin-bottom: 1rem;
            position: relative;
        }

        .mood-webcam video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .mood-webcam .analyzing-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            place-items: center;
            flex-direction: column;
            gap: 1rem;
            color: #fff;
        }

        .mood-webcam .analyzing-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        /* Results */
        .mood-result-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
        }

        .emotion-big {
            text-align: center;
            margin-bottom: 2rem;
        }

        .emotion-big .emoji {
            font-size: 4rem;
            margin-bottom: 0.5rem;
        }

        .emotion-big h2 {
            font-size: 1.6rem;
        }

        .emotion-big p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .emotion-bars {
            margin-bottom: 2rem;
        }

        .emotion-bar {
            margin-bottom: 0.8rem;
        }

        .emotion-bar .bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.82rem;
            margin-bottom: 0.3rem;
        }

        .emotion-bar .bar-label span:first-child {
            color: var(--text-secondary);
        }

        .emotion-bar .bar-label span:last-child {
            color: var(--text-muted);
        }

        .emotion-bar .bar-track {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .emotion-bar .bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease;
        }

        .wellness-tip {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: var(--radius-md);
            padding: 1.2rem;
            margin-top: 1.5rem;
        }

        .wellness-tip h4 {
            font-size: 0.9rem;
            margin-bottom: 0.4rem;
        }

        .wellness-tip p {
            color: var(--text-secondary);
            font-size: 0.82rem;
            line-height: 1.6;
        }

        .mood-history {
            margin-top: 2rem;
        }

        .mood-history-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }

        .mood-history-card h3 {
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .no-result {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .no-result span {
            font-size: 3rem;
            display: block;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .mood-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div id="nav"></div>
    <div class="bg-glow glow-1"></div>
    <div class="bg-glow glow-2"></div>

    <div class="page-content">
        <div class="container mood-page">
            <div class="section-header">
                <h2>üß† Mood & Well-being Check</h2>
                <p>AI-powered facial expression analysis for your well-being</p>
            </div>

            <div class="mood-grid">
                <!-- Camera -->
                <div class="mood-cam-card">
                    <h3>üì∏ Face Scan</h3>
                    <p class="sub">We'll analyze your facial expression to detect your current mood. This is a
                        supportive tool, not a medical diagnosis.</p>

                    <div class="mood-webcam" id="moodWebcam">
                        <video id="moodVideo" autoplay playsinline></video>
                        <div class="analyzing-overlay" id="analyzingOverlay">
                            <div class="spinner"></div>
                            <p>Analyzing your expression...</p>
                        </div>
                    </div>

                    <div style="display:flex; gap:0.8rem;">
                        <button class="btn btn-secondary" onclick="startMoodCam()" id="startMoodBtn">üì∑ Start
                            Camera</button>
                        <button class="btn btn-primary" onclick="analyzeMood()" id="analyzeBtn" style="display:none;">üß†
                            Analyze Mood</button>
                    </div>
                </div>

                <!-- Results -->
                <div class="mood-result-card">
                    <div id="moodResults">
                        <div class="no-result">
                            <span>üîç</span>
                            <p>Start the camera and click "Analyze Mood" to see your results</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mood History Chart -->
            <div class="mood-history">
                <div class="mood-history-card">
                    <h3>üìä Your Mood History</h3>
                    <canvas id="moodHistoryChart" height="120"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="footer"></div>

    <script src="js/app.js"></script>
    <script>
        if (!requireAuth()) throw 'Not logged in';
        document.getElementById('nav').innerHTML = renderNavbar('mood-check');
        document.getElementById('footer').innerHTML = renderFooter();

        const user = getCurrentUser();
        let moodStream = null;

        const emotionEmojis = {
            happy: 'üòä', sad: 'üò¢', angry: 'üò†', surprise: 'üò≤',
            fear: 'üò®', disgust: 'ü§¢', neutral: 'üòê'
        };

        const emotionColors = {
            happy: '#10b981', sad: '#3b82f6', angry: '#f43f5e',
            surprise: '#f59e0b', fear: '#8b5cf6', disgust: '#06b6d4', neutral: '#64748b'
        };

        const wellnessTips = {
            happy: { title: 'üåü You seem happy!', text: 'Great to see you in a good mood! Keep up the positive energy. Consider sharing your happiness with a friend.' },
            sad: { title: 'üíô Feeling down?', text: 'It\'s okay to feel sad sometimes. Consider talking to a friend, listening to music, or taking a walk. If feelings persist, reach out to a counselor.' },
            angry: { title: 'üßò Take a breath', text: 'Try some deep breathing exercises. Count to 10 slowly. Physical activity like a walk or exercise can help release tension.' },
            neutral: { title: 'üòå Feeling balanced', text: 'You seem calm and collected. A good time for focused work or reflection. Consider what goals you want to tackle today.' },
            surprise: { title: '‚ú® Something exciting?', text: 'Surprise can be energizing! Channel that energy into something productive or creative.' },
            fear: { title: 'ü§ó It\'s okay', text: 'Anxiety is natural. Try grounding techniques: focus on 5 things you can see, 4 you can touch, 3 you can hear. You\'re doing great.' },
            disgust: { title: 'üåø Reset your mind', text: 'Step away from what\'s bothering you. Fresh air, a glass of water, and a change of scenery can help reset your perspective.' }
        };

        function startMoodCam() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    moodStream = stream;
                    document.getElementById('moodVideo').srcObject = stream;
                    document.getElementById('startMoodBtn').style.display = 'none';
                    document.getElementById('analyzeBtn').style.display = 'inline-flex';
                })
                .catch(() => showToast('Camera access denied', 'error'));
        }

        function analyzeMood() {
            document.getElementById('analyzingOverlay').classList.add('show');
            document.getElementById('analyzeBtn').disabled = true;

            // Simulate analysis (in production, this would call the Flask API)
            setTimeout(() => {
                const emotions = {
                    happy: Math.random() * 40 + 10,
                    sad: Math.random() * 25,
                    angry: Math.random() * 15,
                    surprise: Math.random() * 20,
                    fear: Math.random() * 10,
                    neutral: Math.random() * 30 + 10
                };

                // Normalize to 100%
                const total = Object.values(emotions).reduce((a, b) => a + b, 0);
                Object.keys(emotions).forEach(k => emotions[k] = (emotions[k] / total * 100));

                // Find dominant
                const dominant = Object.entries(emotions).sort((a, b) => b[1] - a[1])[0][0];
                const confidence = emotions[dominant].toFixed(1);

                // Determine risk level
                let riskLevel = 'low';
                if (emotions.sad > 40 || emotions.fear > 30) riskLevel = 'medium';
                if (emotions.sad > 60 || (emotions.sad > 40 && emotions.fear > 20)) riskLevel = 'high';

                // Save to mood logs
                const logs = DB.get('moodLogs');
                logs.push({
                    id: 'ml-' + Date.now(),
                    studentId: user.id,
                    emotion: dominant,
                    scores: emotions,
                    riskLevel: riskLevel,
                    date: new Date().toISOString()
                });
                DB.set('moodLogs', logs);

                // Render results
                displayResults(dominant, emotions, confidence, riskLevel);

                document.getElementById('analyzingOverlay').classList.remove('show');
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = 'üîÑ Analyze Again';
                renderMoodHistory();
            }, 2500);
        }

        function displayResults(dominant, emotions, confidence, riskLevel) {
            const tip = wellnessTips[dominant] || wellnessTips.neutral;
            const riskBadge = {
                low: '<span class="badge badge-green">Low Risk</span>',
                medium: '<span class="badge badge-amber">Moderate</span>',
                high: '<span class="badge badge-rose">Needs Attention</span>'
            };

            document.getElementById('moodResults').innerHTML = `
        <div class="emotion-big">
          <div class="emoji">${emotionEmojis[dominant]}</div>
          <h2>${dominant.charAt(0).toUpperCase() + dominant.slice(1)}</h2>
          <p>Confidence: ${confidence}% ${riskBadge[riskLevel]}</p>
        </div>

        <div class="emotion-bars">
          ${Object.entries(emotions).sort((a, b) => b[1] - a[1]).map(([emotion, value]) => `
            <div class="emotion-bar">
              <div class="bar-label">
                <span>${emotionEmojis[emotion]} ${emotion}</span>
                <span>${value.toFixed(1)}%</span>
              </div>
              <div class="bar-track">
                <div class="bar-fill" style="width:${value}%; background:${emotionColors[emotion]}"></div>
              </div>
            </div>
          `).join('')}
        </div>

        <div class="wellness-tip">
          <h4>${tip.title}</h4>
          <p>${tip.text}</p>
        </div>
      `;
        }

        function renderMoodHistory() {
            const logs = DB.get('moodLogs').filter(l => l.studentId === user.id).slice(-10);
            const canvas = document.getElementById('moodHistoryChart');

            if (logs.length === 0) {
                canvas.style.display = 'none';
                return;
            }
            canvas.style.display = 'block';

            const labels = logs.map(l => {
                const d = new Date(l.date);
                return d.toLocaleDateString('en', { month: 'short', day: 'numeric' });
            });

            // Map emotions to numeric values for the chart
            const emotionValues = { happy: 5, surprise: 4, neutral: 3, fear: 2, angry: 1.5, disgust: 1, sad: 0.5 };
            const data = logs.map(l => emotionValues[l.emotion] || 3);
            const colors = logs.map(l => emotionColors[l.emotion] || '#64748b');

            // Destroy previous chart if exists
            if (window.moodChart) window.moodChart.destroy();

            window.moodChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Mood Level',
                        data,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139,92,246,0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: colors,
                        pointRadius: 8,
                        pointHoverRadius: 12,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const log = logs[ctx.dataIndex];
                                    return `${emotionEmojis[log.emotion]} ${log.emotion} (${log.riskLevel} risk)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 0, max: 6,
                            ticks: {
                                color: '#64748b',
                                callback: v => ['', 'Sad', 'Low', 'Neutral', 'Good', 'Happy', ''][v] || ''
                            },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: { ticks: { color: '#64748b' }, grid: { display: false } }
                    }
                }
            });
        }

        renderMoodHistory();
    </script>
</body>

</html>